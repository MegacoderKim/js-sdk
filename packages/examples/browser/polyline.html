<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://unpkg.com/rxjs@5.5.5/bundles/Rx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.29.0/date_fns.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtboBD4lM6hMR02qtUjJHua9gFs6PFbQE&libraries=geometry,visualization"></script>
    <script src="../../../node_modules/whatwg-fetch/fetch.js"></script>
    <script src="../../../node_modules/underscore/underscore-min.js"></script>
    <script src="../../../node_modules/ht-utility/dist/ht-utility_browser.js"></script>
    <script src="../../../node_modules/ht-data/dist/ht-data_browser.js"></script>
    <script src="../../../node_modules/ht-api/dist/ht-api_browser.js"></script>
    <script src="../../../node_modules/ht-client/dist/ht-client_browser.js"></script>
    <script src="../../../node_modules/time-aware-polyline/dist/time-aware-polyline_browser.js"></script>
    <script src="../../../node_modules/leaflet/dist/leaflet.js"></script>
    <script src="../../../node_modules/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="../../../node_modules/ht-maps/dist/ht-maps_browser.js"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
    <link rel="stylesheet" href="../../../node_modules/ht-maps/dist/styles.css">
    <link rel="stylesheet" href="../../../node_modules/leaflet/dist/leaflet.css">
    <style>
        #map {
            height: 400px;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

    </style>
    <title>Document</title>
</head>
<body>
<div id="map"></div>
</body>
<script>
    var anim = new timeAwarePolyline.TimeAwareAnimation();
    anim.updatePathBearing = function (path, bearing) {
        // console.log(path, "bearing");
        var last = _.last(path);
        if(last) {
            marker.setPosition(last);
            map.setCenter(last)
        }
        polyline.setPath(path)
    };
    var token = "sk_55fc65eb64c0b10300c54ff79ea3f6ef22981793";

    var id = "172d816a-70b4-4f0f-b751-c5609a6f003e";
    var client = new htClient.initClient({token: token});

    var users = htClient.usersClientFactory();
    users.placeline.setId(id);
    users.placeline.data$.subscribe(placeline => {
        if(placeline) {
            var segments = placeline.segments.filter(s => s.time_aware_polyline);
            var lastSegIndex = segments.length - 1;
            if(lastSegIndex > 0) {
                var lastSeg = segments[lastSegIndex];
                var timeAwareString = lastSeg.time_aware_polyline;
                var a = new timeAwarePolyline.TimeAwareEncoder().decodeTimeAwarePolyline(timeAwareString);
                anim.init(a)
            }

        }
    });
    // var encoded = "i|teFtugjVg|uziyA??A???";
    var polyline = new google.maps.Polyline();
    // anim.initPolylineString(encoded);
    var marker = new google.maps.Marker();
    var mapClass = new htMaps.HtMapClass('google');

    mapClass.initMap(document.getElementById('map'), {center: {lat: 37.79541, lng: -122.43307}, zoom: 10});
    var map = mapClass.map;
    polyline.setMap(map);
    marker.setMap(map)
</script>
</html>